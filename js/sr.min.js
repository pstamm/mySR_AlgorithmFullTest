function angle(t,r,e,o){var n=o-r,i=e-t,s=Math.atan2(n,i);return s*=180/Math.PI,s}function isRotationCorrect(t){return 0==t[0][0]&&1==t[0][4]&&1==t[4][0]&&1==t[4][4]}const borderBlackStartsAt=4096;var SR=SR||{};SR.Marker=function(t,r,e,o){this.id=t,this.corners=r,this.angle=e,this.borderWhite=o},SR.Detector=function(){this.grey=new CV.Image,this.thres=new CV.Image,this.homography=new CV.Image,this.binary=[],this.contours=[],this.polys=[],this.candidates=[]},SR.Detector.prototype.detect=function(t,r,e,o,n,i){return CV.grayscale(t,this.grey),CV.adaptiveThreshold(this.grey,this.thres,2,7),this.contours=CV.findContours(this.thres,this.binary),this.candidates=this.findCandidates(this.contours,.2*t.width,n,e,o),this.candidates=this.clockwiseCorners(this.candidates),this.candidates=this.notTooNear(this.candidates,10),this.findMarkers(this.grey,this.candidates,i,r)},SR.Detector.prototype.findCandidates=function(t,r,e,o,n){var i,s,h,a=[],c=t.length;for(this.polys=[],h=0;h<c;++h)i=t[h],i.length>=r&&(s=CV.approxPolyDP(i,i.length*e),this.polys.push(s),4===s.length&&CV.isContourConvex(s)&&CV.minEdgeLength(s)>=o&&CV.edgeLengthDiferencePercentage(s)<=n&&a.push(s));return a},SR.Detector.prototype.clockwiseCorners=function(t){var r,e,o,n,i,s,h=t.length;for(s=0;s<h;++s)r=t[s][1].x-t[s][0].x,o=t[s][1].y-t[s][0].y,e=t[s][2].x-t[s][0].x,n=t[s][2].y-t[s][0].y,r*n-o*e<0&&(i=t[s][1],t[s][1]=t[s][3],t[s][3]=i);return t},SR.Detector.prototype.notTooNear=function(t,r){var e,o,n,i,s,h,a=[],c=t.length;for(i=0;i<c;++i)for(s=i+1;s<c;++s){for(e=0,h=0;h<4;++h)o=t[i][h].x-t[s][h].x,n=t[i][h].y-t[s][h].y,e+=o*o+n*n;e/4<r*r&&(CV.perimeter(t[i])<CV.perimeter(t[s])?t[i].tooNear=!0:t[s].tooNear=!0)}for(i=0;i<c;++i)t[i].tooNear||a.push(t[i]);return a},SR.Detector.prototype.findMarkers=function(t,r,e,o){var n,i,s,h=[],a=r.length;for(s=0;s<a;++s)if(n=r[s],CV.warp(t,this.homography,n,e),CV.threshold(this.homography,this.homography,CV.otsu(this.homography)),i=this.getMarker(this.homography,n),i&&(h.push(i),o>0&&h.length>=o))return h;return h},SR.Detector.prototype.getMarker=function(t,r){var e,o,n,i,s,h=t.width/7>>>0,a=h*h>>1,c=[],f=[],u=[],d=!1;for(i=0;i<7;++i)for(n=0===i||6===i?1:6,s=0;s<7;s+=n)if(e={x:s*h,y:i*h,width:h,height:h},CV.countNonZero(t,e)>a){if(CV.countNonOne(t,e)>a)return null;d=!0}for(i=0;i<5;++i)for(c[i]=[],s=0;s<5;++s)e={x:(s+1)*h,y:(i+1)*h,width:h,height:h},c[i][s]=d?CV.countNonZero(t,e)>a?0:1:CV.countNonZero(t,e)>a?1:0;f[0]=c,u[0]=this.hammingDistance(f[0]),o={first:u[0],second:0};var g=isRotationCorrect(f[0]);if(g)u[0]=0,o.second=0;else for(i=1;i<4;++i)if(f[i]=this.rotate(f[i-1]),u[i]=this.hammingDistance(f[i]),g=isRotationCorrect(f[i]),g){u[i]=0,o.second=i;break}if(!g)return null;var p="";for(let t=0;t<c.length;t++)for(let r=0;r<c.length;r++){var l=""+f[o.second][t][r];p+=l}var y=stammReis().decodeImage(p);if(!y.success)return null;var C=this.rotate2(r,4-o.second),m=angle(C[0].x,C[0].y,C[1].x,C[1].y);return d||(y.markerCode+=borderBlackStartsAt),new SR.Marker(y.markerCode,C,m,d)},SR.Detector.prototype.hammingDistance=function(t){var r,e,o,n,i,s=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],h=0;for(o=0;o<5;++o){for(e=1/0,n=0;n<4;++n){for(r=0,i=0;i<5;++i)r+=t[o][i]===s[n][i]?0:1;r<e&&(e=r)}h+=e}return h},SR.Detector.prototype.mat2id=function(t){var r,e=0;for(r=0;r<5;++r)e<<=1,e|=t[r][1],e<<=1,e|=t[r][3];return e},SR.Detector.prototype.rotate=function(t){var r,e,o=[],n=t.length;for(r=0;r<n;++r)for(o[r]=[],e=0;e<t[r].length;++e)o[r][e]=t[t[r].length-e-1][r];return o},SR.Detector.prototype.rotate2=function(t,r){var e,o=[],n=t.length;for(e=0;e<n;++e)o[e]=t[(r+e)%n];return o};